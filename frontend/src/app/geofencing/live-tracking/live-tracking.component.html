<div class="tracking-root">

  <!-- â•â•â•â•â•â• HEADER â•â•â•â•â•â• -->
  <div class="page-header">
    <div class="header-left">
      <h2 class="page-title"><span>ğŸ—ºï¸</span> Live Tracking</h2>
      <p class="page-subtitle">Real-time patient monitoring &amp; geofence management</p>
    </div>
    <button class="btn-primary" (click)="openAddModal()"><span>ï¼‹</span> Add Zone</button>
  </div>

  <!-- â•â•â•â•â•â• LOADING â•â•â•â•â•â• -->
  <div class="loading-bar" *ngIf="isLoading">
    <span>â³ Loading zones and positionsâ€¦</span>
  </div>

  <!-- â•â•â•â•â•â• PICK LOCATION BANNER â•â•â•â•â•â• -->
  <div class="pick-banner" *ngIf="pickingLocation">
    <span>ğŸ“ Click on the map to set the zone center.</span>
    <button class="btn-pick-cancel" (click)="pickingLocation = false; showModal = true">âœ• Cancel</button>
  </div>

  <!-- â•â•â•â•â•â• ACTIVE ALERTS â•â•â•â•â•â• -->
  <div class="alert-banner" *ngIf="activeAlerts.length > 0">
    <div class="alert-item" *ngFor="let a of activeAlerts">
      <span>ğŸš¨</span>
      <span><b>{{ a.patientId }}</b> â€” {{ a.type }} ({{ a.distanceHorsZone | number:'1.0-0' }}m out of zone)</span>
      <button class="btn-resolve" (click)="resolveAlert(a)">Resolve</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â• MAP â•â•â•â•â•â• -->
  <div class="map-container">
    <div id="map"></div>
    <div class="map-legend">
      <div class="legend-row"><span class="ldot blue"></span> Safe Zone</div>
      <div class="legend-row"><span class="ldot red-dash"></span> Danger Zone</div>
      <div class="legend-row"><span class="ldot green"></span> Patient â€” OK</div>
      <div class="legend-row"><span class="ldot red"></span> Patient â€” Alert</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â• ZONES LIST â•â•â•â•â•â• -->
  <div class="zones-section">
    <div class="zones-header">
      <h3 class="zones-title">ğŸ“ Configured Zones <span class="count-badge">{{ zones.length }}</span></h3>
    </div>
    <div class="zones-grid">
      <div class="zone-card" *ngFor="let zone of zones" (click)="centerMapOnZone(zone)">
        <div class="zone-strip" [style.background]="zone.type === 'DANGER' ? '#e53935' : '#1565C0'"></div>
        <div class="zone-body">
          <div class="zone-info">
            <span class="zone-name">{{ zone.nomZone }}</span>
            <div class="zone-meta">
              <span class="type-tag" [class.danger-tag]="zone.type === 'DANGER'">{{ zone.type }}</span>
              <span>Patient: <b>{{ zone.patientId }}</b></span>
              <span>â­• {{ zone.rayon }}m</span>
            </div>
          </div>
          <div class="zone-btns" (click)="$event.stopPropagation()">
            <button class="btn-icon-action edit"   title="Edit"   (click)="openEditModal(zone)">âœï¸</button>
            <button class="btn-icon-action delete" title="Delete" (click)="deleteZone(zone)">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>
      <div class="empty-zones" *ngIf="zones.length === 0 && !isLoading">
        <span class="empty-icon">ğŸ—ºï¸</span>
        <p>No zones configured yet. Click "Add Zone" to create one.</p>
      </div>
    </div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-card" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <div class="modal-title-wrap">
        <span>{{ isEditMode ? 'âœï¸' : 'ğŸ“' }}</span>
        <h3 class="modal-title">{{ isEditMode ? 'Edit Zone' : 'New Zone' }}</h3>
      </div>
      <button class="modal-close-btn" (click)="closeModal()">âœ•</button>
    </div>

    <div class="modal-body">

      <div class="form-error" *ngIf="formError">âš ï¸ {{ formError }}</div>

      <!-- Zone Name -->
      <div class="form-group">
        <label class="form-label">Zone Name *</label>
        <input class="form-input" [class.input-error]="errors['nomZone']"
               type="text" placeholder="e.g. Ahmed's Home"
               [(ngModel)]="zoneForm.nomZone" name="nomZone" maxlength="50" />
        <span class="field-error" *ngIf="errors['nomZone']">{{ errors['nomZone'] }}</span>
      </div>

      <!-- Patient ID -->
      <div class="form-group">
        <label class="form-label">Patient ID *</label>
        <input class="form-input" [class.input-error]="errors['patientId']"
               type="text" placeholder="e.g. PATIENT_001"
               [(ngModel)]="zoneForm.patientId" name="patientId" maxlength="30" />
        <span class="field-error" *ngIf="errors['patientId']">{{ errors['patientId'] }}</span>
        <span class="field-hint">Letters, digits, underscores and hyphens only.</span>
      </div>

      <!-- Coordinates -->
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Latitude *</label>
          <input class="form-input" [class.input-error]="errors['centreLat']"
                 type="number" step="0.000001" placeholder="e.g. 36.8065"
                 [(ngModel)]="zoneForm.centreLat" name="lat" />
          <span class="field-error" *ngIf="errors['centreLat']">{{ errors['centreLat'] }}</span>
        </div>
        <div class="form-group">
          <label class="form-label">Longitude *</label>
          <input class="form-input" [class.input-error]="errors['centreLon']"
                 type="number" step="0.000001" placeholder="e.g. 10.1815"
                 [(ngModel)]="zoneForm.centreLon" name="lon" />
          <span class="field-error" *ngIf="errors['centreLon']">{{ errors['centreLon'] }}</span>
        </div>
      </div>

      <button class="btn-pick-map" type="button" (click)="startPickLocation()">
        ğŸ–±ï¸ Pick center from map
      </button>

      <!-- Radius -->
      <div class="form-group">
        <label class="form-label">Radius: <b>{{ zoneForm.rayon }}m</b></label>
        <input class="form-slider" type="range" min="50" max="5000" step="50"
               [(ngModel)]="zoneForm.rayon" name="slider" />
        <div class="slider-labels"><span>50m</span><span>5,000m</span></div>
        <input class="form-input mt-8" [class.input-error]="errors['rayon']"
               type="number" min="10" max="10000" placeholder="Enter radius in meters"
               [(ngModel)]="zoneForm.rayon" name="rayon" />
        <span class="field-error" *ngIf="errors['rayon']">{{ errors['rayon'] }}</span>
      </div>

      <!-- Zone Type -->
      <div class="form-group">
        <label class="form-label">Zone Type *</label>
        <select class="form-input form-select" [(ngModel)]="zoneForm.type" name="type">
          <option value="SAFE">SAFE â€” patient must stay inside</option>
          <option value="DANGER">DANGER â€” patient must stay outside</option>
        </select>
      </div>

      <!-- Preview chip -->
      <div class="type-chip" [class.danger-chip]="zoneForm.type === 'DANGER'">
        <span class="chip-dot"></span>
        <span>
          <b>{{ zoneForm.type }}</b> â€”
          {{ zoneForm.type === 'SAFE'
            ? 'Alert triggered if patient leaves this area.'
            : 'Alert triggered if patient enters this area.' }}
        </span>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn-ghost" (click)="closeModal()">Cancel</button>
      <button class="btn-primary" (click)="saveZone()" [disabled]="isSaving">
        <span *ngIf="!isSaving">{{ isEditMode ? 'ğŸ’¾ Update Zone' : 'âœ… Create Zone' }}</span>
        <span *ngIf="isSaving">â³ Savingâ€¦</span>
      </button>
    </div>

  </div>
</div>