<div class="engagement-container">
    <!-- Navigation Tabs -->
    <nav mat-tab-nav-bar class="nav-tabs">
        <a mat-tab-link routerLink="../activities" routerLinkActive #rla1="routerLinkActive" [active]="rla1.isActive">
            Activités Éducatives
        </a>
        <a mat-tab-link routerLink="../events" routerLinkActive #rla2="routerLinkActive" [active]="rla2.isActive">
            Événements
        </a>
        <a mat-tab-link routerLink="../engagement" routerLinkActive #rla3="routerLinkActive" [active]="rla3.isActive">
            Suivi d'Engagement
        </a>
    </nav>

    <h2>Suivi de l'Engagement des Patients</h2>

    <!-- Statistics Cards -->
    <div class="stats-cards" *ngIf="statistics">
        <mat-card>
            <mat-card-content>
                <div class="stat-value">{{statistics.totalActivities}}</div>
                <div class="stat-label">Total Activités</div>
            </mat-card-content>
        </mat-card>

        <mat-card>
            <mat-card-content>
                <div class="stat-value">{{statistics.activePatients}}</div>
                <div class="stat-label">Patients Actifs</div>
            </mat-card-content>
        </mat-card>

        <mat-card>
            <mat-card-content>
                <div class="stat-value">{{statistics.averageEngagement}}%</div>
                <div class="stat-label">Engagement Moyen</div>
            </mat-card-content>
        </mat-card>
    </div>

    <mat-form-field appearance="outline" class="search-field">
        <mat-label>Rechercher</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Patient, activité...">
        <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort>
            <ng-container matColumnDef="patient">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Patient</th>
                <td mat-cell *matCellDef="let row">{{row.patientName}}</td>
            </ng-container>

            <ng-container matColumnDef="activity">
                <th mat-header-cell *matHeaderCellDef>Activité/Événement</th>
                <td mat-cell *matCellDef="let row">
                    {{row.activityName || row.eventName}}
                </td>
            </ng-container>

            <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Statut</th>
                <td mat-cell *matCellDef="let row">
                    <span class="status-badge" [ngClass]="getStatusClass(row.participationStatus)">
                        {{getStatusLabel(row.participationStatus)}}
                    </span>
                </td>
            </ng-container>

            <ng-container matColumnDef="score">
                <th mat-header-cell *matHeaderCellDef>Score</th>
                <td mat-cell *matCellDef="let row">
                    {{row.score !== undefined ? row.score + '%' : '-'}}
                </td>
            </ng-container>

            <ng-container matColumnDef="progress">
                <th mat-header-cell *matHeaderCellDef>Progression</th>
                <td mat-cell *matCellDef="let row">
                    <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="row.progressPercentage || 0"></div>
                    </div>
                    <span class="progress-text">{{row.progressPercentage || 0}}%</span>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
        <mat-paginator [pageSizeOptions]="[10, 20, 50]" showFirstLastButtons></mat-paginator>
    </div>

    <!-- Charts Section -->
    <app-engagement-charts [statistics]="statistics"></app-engagement-charts>
</div>